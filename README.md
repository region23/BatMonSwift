# BatMon

Лёгкое нативное меню-бар приложение для macOS, которое отслеживает состояние аккумулятора MacBook, собирает историю, визуализирует графики, выполняет продвинутый анализ здоровья батареи и формирует HTML‑отчёт.

## Возможности

- Расчёт износа (MaxCapacity vs DesignCapacity)
- Аналитика:
  - Средний и регрессионный разряд (%/ч)
  - Прогноз автономности 100→0%
  - Оценка здоровья (0–100) с учётом износа, циклов, температуры и «микро‑просадок»
  - Детектирование «micro‑drops» (быстрых падений ≥2% за ≤120 c без зарядки)
  - Аномалии и рекомендация (наблюдать / заменить)
- Калибровка: контролируемый цикл разряда 100% → 20% для точной оценки автономности
- HTML‑отчёт (статический, локальный файл) с картами метрик, спарклайном и таблицей последних измерений
- Полностью оффлайн: нет сетевых запросов

## Требования

| Компонент | Минимум |
|-----------|---------|
| macOS     | 13.0 (Swift Charts) |
| Xcode     | 15.x (Swift 5.9+) |
| Архитектура | Apple Silicon / Intel |

## Сборка и запуск

1. Клонируйте репозиторий
2. Откройте `BatMon.xcodeproj` в Xcode
3. Убедитесь, что таргет платформы — macOS 13+
4. Соберите и запустите (⌘R)
5. Иконка появится в меню‑баре

### Подпись / дистрибуция

Для собственного использования в разработке подпись не обязательна. Для распространения вне Xcode — настройте Developer ID подпись и (опционально) Notarization.

## Архитектура

| Файл | Роль |
|------|------|
| `BatteryService.swift` | Низкоуровневое чтение состояния через IOKit (IOPowerSources + AppleSmartBattery) |
| `BatteryViewModel.swift` | Периодический опрос (Timer), форматирование и паблиш снапшота в UI |
| `HistoryStore.swift` | Персистентная история, тримминг + downsample |
| `AnalyticsEngine.swift` | Анализ трендов разряда, регрессия, оценка здоровья, аномалии, рекомендации |
| `CalibrationEngine.swift` | Состояния калибровки, сбор непрерывного интервала 100%→20%, сериализация прогресса |
| `ChartsPanel.swift` | Визуализация истории через Swift Charts |
| `CalibrationPanel.swift` | UI управления калибровкой |
| `MenuContent.swift` | Главный комбинированный UI (обзор, графики, калибровка, управление) |
| `ReportGenerator.swift` | Генерация статического HTML‑отчёта + SVG спарклайн |
| `BatMonApp.swift` | Точка входа (SwiftUI App), инициализация объектов и связывание |

### Потоки данных

```text
IOKit -> BatteryService -> BatteryViewModel.state -> HistoryStore.append()
                                     |                       
                                     v                       
                           CalibrationEngine (подписка)     
                                     |                       
HistoryStore.items -> AnalyticsEngine.analyze() -> UI / Report
```

### Хранение данных

- Application Support / BatMon
  - `history.json` — временная серия показаний (сжатая по старым диапазонам)
  - `calibration.json` — состояние калибровки + последний результат
- Временные файлы (`*.html`) — в `NSTemporaryDirectory()`

## Аналитика здоровья

Метрики:

- `avgDischargePerHour` — простой средний разряд в %/ч
- `trendDischargePerHour` — наклон линейной регрессии по % от времени (ч)
- `estimatedRuntimeFrom100To0Hours` — прогноз (100 / скорость разряда)
- `microDropEvents` — количество быстрых негативных скачков
- `healthScore` — 100 − штрафы (износ, циклы > 500, температура > 40°C, микро‑просадки)
- `recommendation` — текстовая стратегия (наблюдать / заменить)

## Калибровка

1. Нажмите «Начать калибровку» — состояние `waitingFull`
2. Зарядите до 100%, отключите питание → автоматический старт (`running`)
3. Не подключайте питание до 20%
4. На 20% — вычисление средней скорости разряда и оценки автономности
5. Повторяйте периодически (раз в несколько недель) при изменениях поведения батареи

Пауза (`paused`) срабатывает при подключении питания — требуется перезапуск при 100%.

## Экспорт и отчёт

- Кнопка «Отчёт» генерирует HTML с:
  - Карточками текущих метрик
  - Рекомендацией и аномалиями
  - Последним результатом калибровки (если есть)
  - Спарклайном заряда
  - Таблицей последних измерений
 

## Roadmap / идеи

- [ ] Настройки периода опроса
- [ ] Уведомления о высоких температурах или резких падениях
- [ ] Менеджер нескольких профилей (аккумуляторы / устройства через TargetDisk?)
- [ ] Локализация EN
- [ ] Настраиваемые пороги здоровья

## Конфиденциальность

Приложение работает полностью локально, не отправляет данные в сеть. Генерируемые отчёты остаются на вашем диске.

## Известные ограничения

- Регрессия точнее при ≥4 несущих разрядных точках
- Оценки времени (IOKit TimeToFull / TimeToEmpty) могут быть нестабильны на отдельных моделях
- Температура и напряжение недоступны на некоторых системах (значения будут 0 / «—»)
- Отсутствие батареи (Mac mini / Studio) — часть метрик недоступна, UI корректно адаптирован

## Добавление в автозапуск

Используйте LaunchAgents или `Login Items` в настройках macOS (ручная настройка — не реализовано в коде). Возможная будущая фича.

## Вклад

PR приветствуются. Перед добавлением новых зависимостей — обсудите необходимость (цель: минимализм, отсутствие лишнего сетевого или аналитического кода).

## Лицензия

(вопрос изучается)

---
Если есть пожелания или идеи — добавьте issue.
